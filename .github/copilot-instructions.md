# ActsAsTaggableOnMongoid â€“ AI Guide

- Purpose: Rails/Mongoid tagging gem modeled after acts-as-taggable-on; tags/taggings stored as Mongoid docs with denormalized tag names and optional tagger (owner) support. Core namespaces under `ActsAsTaggableOnMongoid`.
- Configuration defaults and global knobs live in [lib/acts_as_taggable_on_mongoid/configuration.rb](lib/acts_as_taggable_on_mongoid/configuration.rb): `force_lowercase`, `force_parameterize`, `preserve_tag_order`, `cached_in_model`, `remove_unused_tags`, `default_parser` (`DefaultParser` comma-delimited), `tags_table`/`taggings_table`. `strict_case_match` unsupported.
- Adding tagging to a model: `acts_as_taggable` (alias for `:tags`) or `acts_as_taggable_on :skills, :interests` in a Mongoid model ([spec/support/models/09_taggable_model.rb](spec/support/models/09_taggable_model.rb)). `acts_as_ordered_taggable_on` sets `preserve_tag_order: true` ([spec/support/models/ordered_taggable_model.rb](spec/support/models/ordered_taggable_model.rb)).
- Tag definition options (per context) handled by `Taggable::TagTypeDefinition` ([lib/acts_as_taggable_on_mongoid/taggable/tag_type_definition.rb](lib/acts_as_taggable_on_mongoid/taggable/tag_type_definition.rb)): parser override, ordered tags, caching, force lowercase/parameterize, `remove_unused_tags`, default values, tagger ownership defaults (`default_tagger`, `tag_list_uses_default_tagger`), custom tables.
- Dynamic methods per context include `<context>_list` getter/setter, `<context>` tag collection, `<context>_taggings`, `all_<context>_list`, change-tracking helpers (`*_changed?`, `reset_*_to_default!`). Methods are injected via the dynamic mixin module (`Taggable::Core`, `ListMethods`, `Changeable`).
- Tag lists use `TagList` arrays that clean values (strip, optionally downcase/parameterize, uniq) and parse strings via configured parser. `TaggerTagList` groups lists by tagger/owner for taggable models that support taggers ([lib/acts_as_taggable_on_mongoid/tagger_tag_list.rb](lib/acts_as_taggable_on_mongoid/tagger_tag_list.rb)).
- Persistence flow: tag lists stored in-memory until save; `after_save` hook in `Taggable::Core` builds `TagListDiff` to create/destroy `Tagging` docs respecting ordered contexts ([lib/acts_as_taggable_on_mongoid/taggable/utils/tag_list_diff.rb](lib/acts_as_taggable_on_mongoid/taggable/utils/tag_list_diff.rb)). Reload clears cached lists.
- Models: `Tag` and `Tagging` include shared concerns ([lib/acts_as_taggable_on_mongoid/models/concerns](lib/acts_as_taggable_on_mongoid/models/concerns)). Fields are `name`, `taggings_count`, `context`, `taggable_type`, optional polymorphic `owner` (Tag) and `tagger` (Tagging). Indexes enforce uniqueness by context/taggable/owner/tagger; validations mirror that. Hooks keep denormalized `tag_name` in taggings and update cached tag lists when tag names change.
- Taggers/owners: add `acts_as_tagger` to a model to get `owned_<tags>`/`owned_<taggings>` relations ([lib/acts_as_taggable_on_mongoid/tagger.rb](lib/acts_as_taggable_on_mongoid/tagger.rb)). Taggable contexts with `tagger:` option default ownership via taggable methods (see [spec/support/models/12_tagger_taggable_model.rb](spec/support/models/12_tagger_taggable_model.rb)). `TaggerRelation#process_attributes` delays tag list assignment using default tagger until associations are set.
- Querying: `scope :tagged_with` builds Mongo aggregation queries via `TaggedWithQuery` with options `on/context`, `any`, `all` (default), `exclude`, `match_all`, `wild` regex matching, `start_at`/`end_at` ([lib/acts_as_taggable_on_mongoid/taggable/tagged_with.rb](lib/acts_as_taggable_on_mongoid/taggable/tagged_with.rb), [tagged_with_query.rb](lib/acts_as_taggable_on_mongoid/taggable/tagged_with_query.rb)). Context conflicts are checked to ensure compatible definitions.
- Caching: if `cached_in_model` enabled, denormalized tag list stored on the taggable doc as array or string; cache fields auto-defined. Tag/Tagging hooks update/remove cached entries when tag names change or taggings are deleted.
- Defaults: contexts can define `default:` lists; defaults materialize on new records only. Ordered contexts recreate taggings from first ordering change onward.
- Custom tables: swap tag/tagging models via options; custom models must include the same concerns or fields/scopes ([spec/support/models/02_alt_tag.rb](spec/support/models/02_alt_tag.rb) shows a custom tag model). Use `tags_table`/`taggings_table` options per context or globally.
- Testing workflow: `bundle install` then `bundle exec rspec` or `bundle exec rake` (default task) ([Rakefile](Rakefile)). Requires MongoDB on `localhost:27017` using [spec/fixtures/mongoid.yml](spec/fixtures/mongoid.yml). Specs eager-load the gem, create indexes for fixtures, and truncate DB via DatabaseCleaner ([spec/support/database_cleaner.rb](spec/support/database_cleaner.rb), [spec/support/models_indexes.rb](spec/support/models_indexes.rb)).
- Practical examples live in [README.md](README.md) and test models under [spec/support/models](spec/support/models) (cached/defaulted/tagger/ordered variants) for usage patterns and edge cases.
